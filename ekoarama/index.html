<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Eko3 Arama</title>
  <link rel="icon" href="https://gman.dev/favicon" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../ekorota/style.css">
  <style>
    /* Şehir Seçim Ekranı Stilleri */
    .city-selection-screen {
      display: none;
      padding: 16px;
      background: var(--background-main);
      min-height: 100vh;
      max-height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
    }
    
    .city-selection-screen.active {
      display: block;
    }
    
    .city-header {
      text-align: center;
      margin-bottom: 24px;
      padding-top: 20px;
    }
    
    .city-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
    }
    
    .city-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
    
    .location-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--card-background);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 12px 16px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
    }
    
    .location-status.searching {
      border-color: var(--primary-color);
      background: var(--primary-soft);
      color: var(--primary-color);
    }
    
    .location-status i {
      font-size: 0.9rem;
    }
    
    .regions-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding-bottom: 40px; /* Alt kısımda boşluk bırak */
    }
    
    .region-section {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
    }
    
    .region-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .region-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: white;
      border-radius: var(--radius);
      font-size: 1.1rem;
    }
    
    .region-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .city-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--background-soft);
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      margin-left: auto;
    }
    
    .cities-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .city-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--background-soft);
      border: 2px solid transparent;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .city-item:hover {
      border-color: var(--city-color);
      background: var(--card-background);
      transform: translateX(4px);
      box-shadow: var(--shadow);
    }
    
    .city-item.nearest {
      border-color: var(--success-color);
      background: var(--success-light);
    }
    
    .city-icon-small {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--city-color), var(--city-color-light));
      color: white;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    
    .city-info {
      flex: 1;
      min-width: 0;
    }
    
    .city-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    
    .city-routes {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .nearest-badge {
      background: var(--success-color);
      color: white;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-weight: 500;
    }
    
    /* Ana Uygulama Stilleri */
    .main-app {
      display: none;
      flex-direction: column;
      height: 100vh;
      background: var(--background-main);
    }
    
    .main-app.active {
      display: flex;
    }
    
    .app-header {
      background: var(--card-background);
      border-bottom: 1px solid var(--border-light);
      padding: 12px 16px;
      box-shadow: var(--shadow-sm);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }
    
    .app-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .header-back-button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: var(--shadow-sm);
      white-space: nowrap;
    }
    
    .header-back-button:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .header-back-button i {
      font-size: 0.8rem;
    }
    
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .search-section {
      position: relative;
    }
    
    .search-container {
      position: relative;
    }
    
    .search-container input {
      width: 100%;
      padding: 14px 50px 14px 16px;
      border: 2px solid var(--border-light);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      background: var(--card-background);
      color: var(--text-primary);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }
    
    .search-container input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      font-size: 1rem;
    }
    
    .clear-search {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      cursor: pointer;
      display: none;
      transition: color 0.2s ease;
      background: var(--background-soft);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }
    
    .clear-search.visible {
      display: flex;
    }
    
    .clear-search:hover {
      color: var(--danger-color);
      background: var(--danger-light);
    }
    
    .search-results {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-background);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      margin-top: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 50;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .search-results.visible {
      display: block;
    }
    
    .result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .result-item:last-child {
      border-bottom: none;
    }
    
    .result-item:hover {
      background: var(--background-soft);
    }
    
    .result-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--primary-color);
      color: white;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    
    .result-content {
      flex: 1;
      font-size: 0.9rem;
      color: var(--text-primary);
    }
    
    .no-results {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
      font-size: 0.9rem;
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .action-card {
      background: var(--card-background);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      text-align: center;
    }
    
    .action-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .action-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: white;
      border-radius: var(--radius);
      font-size: 1.3rem;
      margin: 0 auto 12px;
    }
    
    .action-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .action-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.4;
    }
    
    .routes-section {
      background: var(--card-background);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0;
    }
    
    .section-title::before {
      content: '';
      display: inline-block;
      width: 3px;
      height: 16px;
      background: var(--primary-color);
      margin-right: 12px;
      border-radius: 2px;
    }
    
    .routes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }
    
    .route-button {
      background: var(--background-soft);
      border: 2px solid var(--border-light);
      border-radius: var(--radius);
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      font-size: 0.9rem;
    }
    
    .route-button:hover {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .sidebar-sections {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .kentkart-section {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
    }
    
    .kentkart-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.95rem;
      margin-bottom: 12px;
    }
    
    .kentkart-header i {
      font-size: 1rem;
    }
    
    .kentkart-input-area {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    #card-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s ease;
    }
    
    #card-input:focus {
      border-color: var(--primary-color);
    }
    
    #save-card-btn {
      padding: 10px 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      min-width: 44px;
    }
    
    #save-card-btn:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
    }
    
    .kentkart-info {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: var(--radius);
      padding: 14px;
      margin-top: 12px;
    }
    
    .balance-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .balance-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .balance-amount {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .balance-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .usage-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
    }
    
    .usage-item {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }
    
    .card-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
    }
    
    .card-btn {
      flex: 1;
      padding: 6px 8px;
      background: white;
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s ease;
    }
    
    .card-btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .nearby-section {
      background: var(--card-background);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
    }
    
    .nearby-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .header-left-nearby {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .header-left-nearby i {
      font-size: 1rem;
    }
    
    .header-buttons {
      display: flex;
      gap: 6px;
    }
    
    .header-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 8px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .header-btn:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
    }
    
    .header-btn i {
      font-size: 0.7rem;
    }
    
    .nearest-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .nearest-list li {
      padding: 10px 12px;
      margin-bottom: 8px;
      background: var(--background-soft);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-primary);
      font-size: 0.85rem;
      border-left: 3px solid transparent;
    }
    
    .nearest-list li:last-child {
      margin-bottom: 0;
    }
    
    .nearest-list li:hover {
      background: var(--primary-soft);
      border-left-color: var(--primary-color);
      transform: translateX(3px);
    }
    
    /* Animasyonlar */
    .city-item {
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.4s ease forwards;
    }
    
    .city-item:nth-child(1) { animation-delay: 0.1s; }
    .city-item:nth-child(2) { animation-delay: 0.2s; }
    .city-item:nth-child(3) { animation-delay: 0.3s; }
    .city-item:nth-child(4) { animation-delay: 0.4s; }
    .city-item:nth-child(5) { animation-delay: 0.5s; }
    
    .route-button {
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.3s ease forwards;
    }
    
    .route-button:nth-child(1) { animation-delay: 0.1s; }
    .route-button:nth-child(2) { animation-delay: 0.15s; }
    .route-button:nth-child(3) { animation-delay: 0.2s; }
    .route-button:nth-child(4) { animation-delay: 0.25s; }
    .route-button:nth-child(5) { animation-delay: 0.3s; }
    .route-button:nth-child(6) { animation-delay: 0.35s; }
    .route-button:nth-child(7) { animation-delay: 0.4s; }
    .route-button:nth-child(8) { animation-delay: 0.45s; }
    
    .nearest-list li {
      opacity: 0;
      transform: translateX(-20px);
      animation: slideRight 0.3s ease forwards;
    }
    
    .nearest-list li:nth-child(1) { animation-delay: 0.1s; }
    .nearest-list li:nth-child(2) { animation-delay: 0.2s; }
    .nearest-list li:nth-child(3) { animation-delay: 0.3s; }
    
    @keyframes slideUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideRight {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Scrollbar */
    .main-content::-webkit-scrollbar,
    .city-selection-screen::-webkit-scrollbar,
    .search-results::-webkit-scrollbar {
      width: 6px;
    }
    
    .main-content::-webkit-scrollbar-track,
    .city-selection-screen::-webkit-scrollbar-track,
    .search-results::-webkit-scrollbar-track {
      background: var(--background-secondary);
      border-radius: 3px;
    }
    
    .main-content::-webkit-scrollbar-thumb,
    .city-selection-screen::-webkit-scrollbar-thumb,
    .search-results::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }
    
    .main-content::-webkit-scrollbar-thumb:hover,
    .city-selection-screen::-webkit-scrollbar-thumb:hover,
    .search-results::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }
    
    /* Mobil tablet için */
    @media (min-width: 768px) {
      .cities-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .quick-actions {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .main-content {
        padding: 20px;
        gap: 20px;
      }
      
      .regions-container {
        gap: 24px;
      }
    }
    
    /* Büyük ekranlar için */
    @media (min-width: 1024px) {
      .city-selection-screen {
        padding: 24px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .cities-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }
    }

    /* Loading states */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .loading i {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Status messages */
    .status-message {
      text-align: center;
      padding: 16px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      margin: 16px 0;
    }
    
    .status-message.info {
      background: var(--primary-soft);
      color: var(--primary-color);
      border: 1px solid var(--primary-light);
    }
    
    .status-message.error {
      background: var(--danger-light);
      color: var(--danger-color);
      border: 1px solid var(--danger-border);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Şehir Seçme Ekranı -->
    <div class="city-selection-screen active" id="city-selection-screen">
      <div class="city-header">
        <h1 class="city-title">EkoGökhan3</h1>
        <p class="city-subtitle">Şehrinizi seçin</p>
        
        <div class="location-status" id="location-status">
          <i class="fas fa-location-dot"></i>
          <span>Konumunuz kontrol ediliyor...</span>
        </div>
      </div>
      
      <div class="regions-container" id="regions-container"></div>
    </div>

    <!-- Ana Uygulama Ekranı -->
    <div class="main-app" id="main-app">
      <header class="app-header">
        <div class="header-left">
          <h1 class="app-title" id="app-title">EkoGökhan3</h1>
        </div>
        <button class="header-back-button" id="back-button">
          <i class="fas fa-exchange-alt"></i>
          <span>Şehir</span>
        </button>
      </header>

      <div class="main-content">
        <div class="search-section">
          <div class="search-container">
            <input id="search-input" type="text" placeholder="Hat veya durak ara..." oninput="this.value=this.value.toUpperCase()">
            <div class="search-icon"><i class="fas fa-search"></i></div>
            <div class="clear-search" id="clear-search"><i class="fas fa-times"></i></div>
          </div>
          
          <div class="search-results" id="search-results"></div>
        </div>
        
        <div class="quick-actions">
          <div class="action-card" id="route-finder-action">
            <div class="action-icon">
              <i class="fas fa-route"></i>
            </div>
            <div class="action-title">Rota Bulma</div>
            <div class="action-subtitle">En kısa yolu keşfet</div>
          </div>
          
          <div class="action-card" id="map-action">
            <div class="action-icon">
              <i class="fas fa-map"></i>
            </div>
            <div class="action-title">Harita</div>
            <div class="action-subtitle">Durakları görüntüle</div>
          </div>
          
        </div>

        <div class="routes-section">
          <div class="section-header">
            <h2 class="section-title">Popüler Hatlar</h2>
          </div>
          <div class="routes-grid" id="routes-grid"></div>
        </div>

        <div class="sidebar-sections">
          <!-- Kentkart Bakiye Bölümü -->
          <div class="kentkart-section" id="kentkart-section">
            <div class="kentkart-header">
              <i class="fas fa-credit-card"></i>
              <span>Kentkart</span>
            </div>
            <div id="kentkart-content">
              <div class="kentkart-input-area">
                <input type="text" id="card-input" placeholder="Kart numaranızı girin" maxlength="11">
                <button id="save-card-btn"><i class="fas fa-save"></i></button>
              </div>
            </div>
          </div>

          <!-- Yakın Duraklar -->
          <div class="nearby-section">
            <div class="nearby-header">
              <div class="header-left-nearby">
                <i class="fas fa-location-dot"></i>
                <span>Yakın Duraklar</span>
              </div>
              <div class="header-buttons">
                <button class="header-btn" id="refresh-btn">
                  <i class="fas fa-sync-alt"></i>
                  Yenile
                </button>
                <button class="header-btn" id="nearby-btn">
                  <i class="fas fa-map"></i>
                  Harita
                </button>
              </div>
            </div>
            <ul id="nearest-stops" class="nearest-list">
              <li class="loading">
                <i class="fas fa-spinner"></i>
                <span>Konum alınıyor...</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

şuanda kullanıcı siteyi açar açmaz otomatik konumu sayesinde şehri açılıyor ama otomatik şehri açıldıktan sonra şehirlere basınca tekrardan otomatik şehri açılıyor

<script>
const CONFIG = {
  '004': { name: 'Kocaeli', routes: ['24','33','41K','80','115','138','211','126','105'], colors: ['#0369a1', '#0ea5e9'], icon: 'fa-industry', region: 'Marmara', coords: [40.7686795, 29.9526597] },
  '010': { name: 'Muğla', routes: ['48-2','5-8','3-14','5-15','3-22','5-7','5-9','3-12','5-3B'], colors: ['#059669', '#10b981'], icon: 'fa-umbrella-beach', region: 'Ege', coords: [37.2153, 28.3636] },
  '003': { name: 'Adana', routes: ['700','158','175','172','162','144','151','118','165'], colors: ['#dc2626', '#ef4444'], icon: 'fa-wheat-awn', region: 'Akdeniz', coords: [37.0000, 35.3213] },
  '019': { name: 'Alanya', routes: ['1','2','202','101','3','11','12','15','13'], colors: ['#d97706', '#f59e0b'], icon: 'fa-sun', region: 'Akdeniz', coords: [36.5444, 31.9956] },
  '029': { name: 'Alaplı', routes: ['09','09A','09B','08A','08','01','02A','07','02'], colors: ['#7c3aed', '#8b5cf6'], icon: 'fa-mountain', region: 'Karadeniz', coords: [41.1833, 31.3833] },
  '017': { name: 'Burdur', routes: ['2','22','12','1','13','11','21','4','6'], colors: ['#2563eb', '#3b82f6'], icon: 'fa-water', region: 'Akdeniz', coords: [37.7167, 30.2833] },
  '007': { name: 'Çanakkale', routes: ['11G-T','11G','11Ç','G.EKS','11K','ÇT3','OGR1','Ç3','Ç8'], colors: ['#b91c1c', '#dc2626'], icon: 'fa-anchor', region: 'Marmara', coords: [40.1553, 26.4142] },
  '036': { name: 'Düzce', routes: ['13','51','50','40','14','30','114','16','23-A'], colors: ['#065f46', '#047857'], icon: 'fa-tree', region: 'Karadeniz', coords: [40.8438, 31.1565] },
  '013': { name: 'Edirne', routes: ['3A','3C','5A','6A','2A','6','2B','7E','3'], colors: ['#7c2d12', '#9a3412'], icon: 'fa-mosque', region: 'Marmara', coords: [41.6818, 26.5623] },
  '020': { name: 'Ereğli', routes: ['26','3','9B','25','8B','2','8A','5','20'], colors: ['#1e40af', '#2563eb'], icon: 'fa-ship', region: 'Karadeniz', coords: [41.2833, 31.4167] },
  '032': { name: 'Mardin', routes: ['TR24','TR7','KA','TR3','KA1','TR4','M7A','TR6','H2'], colors: ['#a16207', '#ca8a04'], icon: 'fa-city', region: 'Güneydoğu Anadolu', coords: [37.3212, 40.7245] },
  '026': { name: 'Antalya', routes: ['SD20','SD20A','KL21','VML54A','VML54','DM85','KC35A','VC53','511'], colors: ['#0891b2', '#06b6d4'], icon: 'fa-umbrella-beach', region: 'Akdeniz', coords: [36.8841, 30.7056] },
  '023': { name: 'Niğde', routes: ['3','1','2','4','6','5','9','7','8'], colors: ['#9333ea', '#a855f7'], icon: 'fa-mountain-city', region: 'İç Anadolu', coords: [37.9667, 34.6833] },
  '025': { name: 'Kastamonu', routes: ['13','4','2','12','13+','10','11','1','3SS'], colors: ['#166534', '#16a34a'], icon: 'fa-seedling', region: 'Karadeniz', coords: [41.3887, 33.7827] },
  '027': { name: 'Kırklareli', routes: ['04','01','03','02','05','07','08','06'], colors: ['#be123c', '#e11d48'], icon: 'fa-car', region: 'Marmara', coords: [41.7333, 27.2167] },
  '031': { name: 'Ordu', routes: ['64','64A','57','54','52A','67','61','68A','64B'], colors: ['#15803d', '#22c55e'], icon: 'fa-fish', region: 'Karadeniz', coords: [40.9839, 37.8764] },
  '033': { name: 'Osmaniye', routes: ['A8','A9','A7','A2','A4','A15','A5','A16','A6'], colors: ['#c2410c', '#ea580c'], icon: 'fa-seedling', region: 'Akdeniz', coords: [37.0742, 36.2611] },
  '037': { name: 'Safranbolu', routes: ['SK','1B','1A','7','3S','8','2','SK1','5'], colors: ['#eab308', '#facc15'], icon: 'fa-house-chimney', region: 'Karadeniz', coords: [41.2500, 32.6833] },
  '005': { name: 'Sivas', routes: ['14-E','14-B','15-E','15-B','14-C','4-A','5-A','2-A','1-A'], colors: ['#7c3aed', '#8b5cf6'], icon: 'fa-mountain-sun', region: 'İç Anadolu', coords: [39.7477, 37.0179] },
  '011': { name: 'Yozgat', routes: ['HATYOKAGA'], colors: ['#059669', '#10b981'], icon: 'fa-tractor', region: 'İç Anadolu', coords: [39.8181, 34.8147] }
};

const REGION_ICONS = {
  'Marmara': 'fa-water',
  'Ege': 'fa-leaf',
  'Akdeniz': 'fa-sun',
  'Karadeniz': 'fa-mountain',
  'Güneydoğu Anadolu': 'fa-star-and-crescent',
  'İç Anadolu': 'fa-horse'
};

let region = null;
let routeData = null;
let searchTimeout = null;
let locationProcessed = false;
let nearestCity = null;
let userMadeChoice = false; // Kullanıcının manuel seçim yaptığını takip et
let autoSelectionDone = false; // sadece bir kez otomatik seçim yapılsın

const els = {
  cityScreen: document.getElementById('city-selection-screen'),
  mainApp: document.getElementById('main-app'),
  regionsContainer: document.getElementById('regions-container'),
  locationStatus: document.getElementById('location-status'),
  appTitle: document.getElementById('app-title'),
  input: document.getElementById('search-input'),
  searchResults: document.getElementById('search-results'),
  clearSearch: document.getElementById('clear-search'),
  routesGrid: document.getElementById('routes-grid'),
  nearestStops: document.getElementById('nearest-stops'),
  backButton: document.getElementById('back-button'),
  routeFinderAction: document.getElementById('route-finder-action'),
  mapAction: document.getElementById('map-action'),
  nearbyBtn: document.getElementById('nearby-btn'),
  refreshBtn: document.getElementById('refresh-btn'),
  cardInput: document.getElementById('card-input'),
  saveCardBtn: document.getElementById('save-card-btn'),
  kentkartContent: document.getElementById('kentkart-content')
};

// Utility functions
const haversine = (lat1, lon1, lat2, lon2) => {
  const toRad = x => x * Math.PI / 180;
  const R = 6371e3;
  const φ1 = toRad(lat1), φ2 = toRad(lat2);
  const Δφ = toRad(lat2 - lat1), Δλ = toRad(lon2 - lon1);
  const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * R;
};

const updateUrl = r => {
  const url = new URL(window.location);
  url.searchParams.set('region', r);
  window.history.replaceState({}, '', url);
};

const navigateToRoute = route => {
  const back = encodeURIComponent(window.location.href);
  window.location.href = `https://gman.dev/ekorota/?region=${region}&route=${route}&direction=0&back=${back}`;
};

const navigateToRouteFinder = () => {
  const back = encodeURIComponent(window.location.href);
  window.location.href = `https://gman.dev/ekobul/?region=${region}&back=${back}`;
};

// Location functions
const findNearestCity = async () => {
  if (locationProcessed) return nearestCity;
  locationProcessed = true;
  
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      resolve(null);
      return;
    }
    
    const timeoutId = setTimeout(() => {
      resolve(null);
    }, 8000);
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        clearTimeout(timeoutId);
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        
        let nearest = null;
        let shortestDistance = Infinity;
        
        Object.entries(CONFIG).forEach(([code, cityData]) => {
          const [cityLat, cityLon] = cityData.coords;
          const distance = haversine(userLat, userLon, cityLat, cityLon);
          
          if (distance < shortestDistance) {
            shortestDistance = distance;
            nearest = code;
          }
        });
        
        if (nearest && shortestDistance < 100000) { // 100km radius
          nearestCity = nearest;
          resolve(nearest);
        } else {
          resolve(null);
        }
      },
      (error) => {
        clearTimeout(timeoutId);
        console.log('Konum alınamadı:', error.message);
        resolve(null);
      },
      {
        enableHighAccuracy: false,
        timeout: 6000,
        maximumAge: 600000
      }
    );
  });
};

// UI Creation functions
const createRegionsUI = async () => {
  els.locationStatus.classList.add('searching');
  
  // Find nearest city first
  const nearest = await findNearestCity();
  
  if (nearest) {
    els.locationStatus.innerHTML = `
      <i class="fas fa-check-circle"></i>
      <span>En yakın şehir: ${CONFIG[nearest].name}</span>
    `;
    els.locationStatus.classList.remove('searching');
    els.locationStatus.classList.add('info');
  } else {
    els.locationStatus.innerHTML = `
      <i class="fas fa-info-circle"></i>
      <span>Konum alınamadı, şehrinizi seçin</span>
    `;
    els.locationStatus.classList.remove('searching');
  }
  
  // Group cities by region
  const regions = {};
  Object.entries(CONFIG).forEach(([code, cityData]) => {
    if (!regions[cityData.region]) {
      regions[cityData.region] = [];
    }
    regions[cityData.region].push({ code, ...cityData });
  });

  // Create region sections
  els.regionsContainer.innerHTML = '';
  
  Object.entries(regions).forEach(([regionName, cities]) => {
    const regionSection = document.createElement('div');
    regionSection.className = 'region-section';
    
    regionSection.innerHTML = `
      <div class="region-header">
        <div class="region-icon">
          <i class="fas ${REGION_ICONS[regionName] || 'fa-map'}"></i>
        </div>
        <div class="region-name">${regionName}</div>
        <div class="city-count">${cities.length} şehir</div>
      </div>
      <div class="cities-grid">
        ${cities.map(city => `
          <div class="city-item ${nearest === city.code ? 'nearest' : ''}" 
               onclick="selectCity('${city.code}')"
               style="--city-color: ${city.colors[0]}; --city-color-light: ${city.colors[1]}">
            <div class="city-icon-small">
              <i class="fas ${city.icon}"></i>
            </div>
            <div class="city-info">
              <div class="city-name">${city.name}</div>
              <div class="city-routes">${city.routes.slice(0, 4).join(', ')}${city.routes.length > 4 ? '...' : ''}</div>
            </div>
            ${nearest === city.code ? '<div class="nearest-badge">En Yakın</div>' : ''}
          </div>
        `).join('')}
      </div>
    `;
    
    els.regionsContainer.appendChild(regionSection);
  });
  
  // Auto-select nearest city only if user hasn't made a choice
  if (nearest && !userMadeChoice && !autoSelectionDone) {
    setTimeout(() => {
      if (!userMadeChoice && !autoSelectionDone) {
        autoSelectionDone = true; // artık tekrar otomatik seçilmesin
        selectCity(nearest);
      }
    }, 0);
  }
};

// City selection
const selectCity = (cityCode) => {
  userMadeChoice = true; // Kullanıcı manuel seçim yaptı
  region = cityCode;
  updateUrl(cityCode);
  
  els.appTitle.textContent = `EkoGökhan3 - ${CONFIG[cityCode].name}`;
  els.cityScreen.classList.remove('active');
  els.mainApp.classList.add('active');
  
  createRouteButtons();
  fetchRouteData();
  loadNearestStops();
  loadCardInfo();
  
  // Setup action handlers
  els.routeFinderAction.onclick = navigateToRouteFinder;
  els.mapAction.onclick = () => window.location.href = `https://gman.dev/ekoharita/?region=${region}`;
  els.nearbyBtn.onclick = () => window.location.href = `https://gman.dev/ekoharita/?region=${region}`;
};

const goBackToCitySelection = () => {
  els.mainApp.classList.remove('active');
  els.cityScreen.classList.add('active');
  clearSearch();
  locationProcessed = false;
  nearestCity = null;
  userMadeChoice = false;   
  
  setTimeout(() => {
    createRegionsUI();
  }, 300);
};

// Route functions
const createRouteButtons = () => {
  els.routesGrid.innerHTML = '';
  CONFIG[region].routes.forEach((code, i) => {
    const btn = document.createElement('div');
    btn.className = 'route-button';
    btn.textContent = code;
    btn.onclick = () => navigateToRoute(code);
    els.routesGrid.appendChild(btn);
  });
};

const fetchRouteData = async () => {
  try {
    const res = await fetch(`https://service.kentkart.com/rl1//web/nearest/find?region=${region}&lang=tr&authType=4&version=Web_1.8.1(32)_1.0_FIREFOX_kentkart.web.mkentkart`);
    routeData = await res.json();
  } catch (e) { 
    console.error('Route data fetch error:', e); 
  }
};

// Search functions
const clearSearch = () => {
  els.input.value = '';
  els.searchResults.innerHTML = '';
  els.searchResults.classList.remove('visible');
  els.clearSearch.classList.remove('visible');
};

const searchData = async () => {
  const query = els.input.value.trim();
  
  if (!query) {
    els.searchResults.classList.remove('visible');
    return;
  }
  
  els.searchResults.classList.add('visible');
  els.searchResults.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><span>Aranıyor...</span></div>';
  
  const routes = routeData?.routeList?.filter(r => 
    r.displayRouteCode.includes(query) || r.name.toUpperCase().includes(query)
  ) || [];
  
  let stops = [];
  try {
    const res = await fetch(`https://service.kentkart.com/rl1/web/nearest/find?region=${region}&authType=4&version=Web_1.8.1(32)_1.0_FIREFOX_kentkart.web.mkentkart&lang=tr&keyword=${encodeURIComponent(query)}`);
    const data = await res.json();
    stops = data?.stopList || [];
  } catch (e) {
    console.error('Stop search error:', e);
  }
  
  els.searchResults.innerHTML = '';
  
  const allResults = [...routes, ...stops];
  
  if (allResults.length === 0) {
    els.searchResults.innerHTML = '<div class="no-results"><i class="fas fa-search" style="margin-right:8px;opacity:0.5;"></i>Sonuç bulunamadı.</div>';
    return;
  }
  
  allResults.forEach(item => {
    const div = document.createElement('div');
    div.className = 'result-item';
    
    if (item.displayRouteCode) {
      // Route result
      div.innerHTML = `
        <div class="result-icon"><i class="fas fa-bus"></i></div>
        <div class="result-content">
          <strong>${item.displayRouteCode}</strong> - ${item.name}
        </div>
      `;
      div.onclick = () => {
        navigateToRoute(item.displayRouteCode);
        clearSearch();
      };
    } else {
      // Stop result
      div.innerHTML = `
        <div class="result-icon"><i class="fas fa-map-marker-alt"></i></div>
        <div class="result-content">${item.name}</div>
      `;
      div.onclick = () => {
        const back = encodeURIComponent(window.location.href);
        window.location.href = `https://gman.dev/ekostop/?region=${region}&stop=${item.stopId}&back=${back}`;
      };
    }
    
    els.searchResults.appendChild(div);
  });
};

const debouncedSearch = () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(searchData, 400);
  els.clearSearch.classList.toggle('visible', !!els.input.value.trim());
};

// Nearest stops functions
const loadNearestStops = async () => {
  els.nearestStops.innerHTML = '<li class="loading"><i class="fas fa-spinner"></i><span>Konum alınıyor...</span></li>';
  
  try {
    let pos;
    let isDefault = false;
    
    try {
      if (!navigator.geolocation) throw new Error('Geolocation not supported');
      
      pos = await new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => reject(new Error('Timeout')), 8000);
        navigator.geolocation.getCurrentPosition(
          p => {
            clearTimeout(timeoutId);
            resolve(p.coords);
          }, 
          e => {
            clearTimeout(timeoutId);
            reject(e);
          },
          { enableHighAccuracy: false, timeout: 6000, maximumAge: 300000 }
        );
      });
    } catch (err) {
      pos = { latitude: CONFIG[region].coords[0], longitude: CONFIG[region].coords[1] };
      isDefault = true;
    }
    
    // Fetch stops data
    const locRes = await fetch(`https://gman.dev/ekodata/stops/${region}.json`);
    const responseText = await locRes.text();
    
    const lines = responseText.trim().split('\n');
    const stops = lines.map(line => {
      try {
        return JSON.parse(line);
      } catch (e) {
        return null;
      }
    }).filter(stop => stop !== null);
    
    // Calculate distances and sort
    const sorted = stops
      .map(stop => ({
        id: stop.stopId,
        name: stop.stopName,
        dist: haversine(pos.latitude, pos.longitude, parseFloat(stop.lat), parseFloat(stop.lng))
      }))
      .sort((a, b) => a.dist - b.dist)
      .slice(0, 4);

    els.nearestStops.innerHTML = '';
    
    if (isDefault) {
      const statusLi = document.createElement('li');
      statusLi.className = 'status-message info';
      statusLi.innerHTML = '<i class="fas fa-info-circle"></i> Konumunuz alınamadı, şehir merkezi durakları gösteriliyor';
      statusLi.style.cursor = 'default';
      statusLi.style.marginBottom = '12px';
      els.nearestStops.appendChild(statusLi);
    }
    
    sorted.forEach(stop => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${stop.name}</strong>
        <small style="display: block; margin-top: 4px; opacity: 0.7;">
          <i class="fas fa-walking"></i> ${Math.round(stop.dist)}m uzaklıkta
        </small>
      `;
      li.onclick = () => {
        const back = encodeURIComponent(window.location.href);
        window.location.href = `https://gman.dev/ekostop/?region=${region}&stop=${stop.id}&back=${back}`;
      };
      els.nearestStops.appendChild(li);
    });
    
  } catch (err) {
    console.error('Nearest stops error:', err);
    els.nearestStops.innerHTML = `
      <li class="status-message error">
        <i class="fas fa-exclamation-triangle"></i>
        Duraklar yüklenirken hata oluştu
        <button onclick="loadNearestStops()" style="margin-top: 8px; padding: 6px 12px; background: var(--danger-color); color: white; border: none; border-radius: var(--radius); cursor: pointer;">
          Tekrar Dene
        </button>
      </li>
    `;
  }
};

// Kentkart functions
const saveCard = () => {
  const cardNumber = els.cardInput.value.trim();
  if (cardNumber.length < 9) {
    showMessage('Kart numarası en az 9 haneli olmalıdır!', 'error');
    return;
  }
  
  try {
    const cards = JSON.parse(localStorage.getItem('kentkart_cards') || '{}');
    cards[region] = cardNumber;
    localStorage.setItem('kentkart_cards', JSON.stringify(cards));
    loadCardInfo();
    showMessage('Kart kaydedildi!', 'success');
  } catch (e) {
    console.error('Save card error:', e);
    showMessage('Kart kaydedilemedi!', 'error');
  }
};

const loadCardInfo = async () => {
  try {
    const cards = JSON.parse(localStorage.getItem('kentkart_cards') || '{}');
    const cardNumber = cards[region];
    
    if (!cardNumber) {
      els.kentkartContent.innerHTML = `
        <div class="kentkart-input-area">
          <input type="text" id="card-input" placeholder="Kart numaranızı girin (son 2 hanesi olmadan)" maxlength="11">
          <button id="save-card-btn"><i class="fas fa-save"></i></button>
        </div>
      `;
      
      els.cardInput = document.getElementById('card-input');
      els.saveCardBtn = document.getElementById('save-card-btn');
      els.saveCardBtn.onclick = saveCard;
      return;
    }

    els.kentkartContent.innerHTML = '<div class="loading" style="padding: 16px;"><i class="fas fa-spinner"></i><span>Bakiye sorgulanıyor...</span></div>';
    
    const response = await fetch(`https://service.kentkart.com/rl1/api/card/balance?region=${region}&lang=tr&authType=3&token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrZW50a2FydC5jb20iLCJzdWIiOiJBQzE2IiwiYXVkIjoiYUMxdW4iLCJleHAiOjE3NjcyMTQ4MDAsIm5iZiI6MTY5Mjk2ODY2OSwiaWF0IjoxNjkyOTY4NjY5LCJqdGkiOiJmOWM5MDFmMi1iMTgzLTQ1NjYtYjIwYi1hMGI0YjZiYzM0MjUiLCJzeXN0ZW1faWQiOiIwMDQiLCJzY29wZXMiOltdfQ.V9c4Ud9Vjpc1bzHXnM1aL96xLCgeWQ1B3NejsdMTYow_eHgu8M6FiYFqYu9d56VjYwAJ7eMpFvr7cQPfRKCcAzB4MB0tyJWwS6LZybKlZvpu5XMiVhrh_wDYvvhbLO22oucYL7OIke0LFf92DLE65uhO7bbUv6pG6-RCUND7Ggn-v5B8XjjtYNUGU5-L27vr5iVLH_7pA7-Pw4EPHUQRP1rocxnhQYkVwk5T2I_NIMYOaL3ycDa_Mv_u9SfB0hBgcp9cEVU9PoxvlX8TP24rRjJtGVSlt0ina8EFh-20FzlqBPc8OjFjAbjegaynmOtrPOf3hCcrm80ZgS60o4IpOw&alias=${cardNumber}`);
    
    const data = await response.json();
    
    if (data.result?.code === 0 && data.cardlist?.length > 0) {
      const card = data.cardlist[0];
      const lastUsage = card.usage?.find(u => u.type === 0);
      const lastRecharge = card.usage?.find(u => u.type === 1);
      
      els.kentkartContent.innerHTML = `
        <div class="kentkart-info">
          <div class="balance-row">
            <div class="balance-left">
              <span class="balance-amount">${card.balance} ₺</span>
              <span class="balance-label">Bakiye</span>
            </div>
            <div class="usage-info">
              ${lastUsage ? `<div class="usage-item"><span>${lastUsage.date.split(' ')[0]}</span><span>${lastUsage.amt} ₺</span><i class="fas fa-arrow-down" style="color:#dc2626;"></i></div>` : ''}
              ${lastRecharge ? `<div class="usage-item"><span>${lastRecharge.date.split(' ')[0]}</span><span>${lastRecharge.amt} ₺</span><i class="fas fa-arrow-up" style="color:#059669;"></i></div>` : ''}
            </div>
          </div>
          <div class="card-actions">
            <button class="card-btn" onclick="loadCardInfo()">
              <i class="fas fa-sync-alt"></i> Yenile
            </button>
            <button class="card-btn" onclick="removeCard()">
              <i class="fas fa-trash"></i> Kaldır
            </button>
          </div>
        </div>
      `;
    } else {
      els.kentkartContent.innerHTML = `
        <div class="status-message error">
          <i class="fas fa-exclamation-triangle"></i>
          Kart bilgisi alınamadı
          <button class="card-btn" onclick="removeCard()" style="margin-top: 12px; width: auto; padding: 8px 16px;">
            <i class="fas fa-trash"></i> Kaldır
          </button>
        </div>
      `;
    }
  } catch (e) {
    console.error('Load card info error:', e);
    els.kentkartContent.innerHTML = `
      <div class="status-message error">
        <i class="fas fa-wifi"></i>
        Bağlantı hatası
        <button class="card-btn" onclick="loadCardInfo()" style="margin-top: 12px; width: auto; padding: 8px 16px;">
          <i class="fas fa-redo"></i> Tekrar Dene
        </button>
      </div>
    `;
  }
};

const removeCard = () => {
  try {
    const cards = JSON.parse(localStorage.getItem('kentkart_cards') || '{}');
    delete cards[region];
    localStorage.setItem('kentkart_cards', JSON.stringify(cards));
    loadCardInfo();
    showMessage('Kart kaldırıldı!', 'success');
  } catch (e) {
    console.error('Remove card error:', e);
    showMessage('Kart kaldırılamadı!', 'error');
  }
};

// Global functions for onclick handlers
window.removeCard = removeCard;
window.loadCardInfo = loadCardInfo;
window.loadNearestStops = loadNearestStops;

// Utility functions
const showMessage = (message, type = 'info') => {
  const messageEl = document.createElement('div');
  messageEl.className = `status-message ${type}`;
  messageEl.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
  messageEl.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    min-width: 200px;
    max-width: 90vw;
    animation: messageSlide 0.3s ease-out;
  `;
  
  document.body.appendChild(messageEl);
  
  setTimeout(() => {
    if (messageEl.parentNode) {
      messageEl.style.animation = 'messageSlide 0.3s ease-out reverse';
      setTimeout(() => messageEl.remove(), 300);
    }
  }, 3000);
  
  // Add animation CSS if not exists
  if (!document.querySelector('#message-animations')) {
    const style = document.createElement('style');
    style.id = 'message-animations';
    style.textContent = `
      @keyframes messageSlide {
        from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
};

// Event listeners setup
const setupEventListeners = () => {
  // Search functionality
  els.input.addEventListener('input', debouncedSearch);
  els.clearSearch.addEventListener('click', clearSearch);
  
  // Navigation
  els.backButton.addEventListener('click', goBackToCitySelection);
  
  // Refresh nearby stops
  els.refreshBtn.addEventListener('click', loadNearestStops);
  
  // Close search results when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-section')) {
      els.searchResults.classList.remove('visible');
    }
  });
  
  // Prevent search results from closing when clicking inside
  els.searchResults.addEventListener('click', (e) => {
    e.stopPropagation();
  });
};

// Initialize app
window.addEventListener('load', async () => {
  setupEventListeners();
  
  const urlRegion = new URLSearchParams(window.location.search).get('region');
  
  if (urlRegion && CONFIG[urlRegion]) {
    userMadeChoice = true; // URL'den gelen seçim de manuel kabul edilir
    selectCity(urlRegion);
    return;
  }
  
  // Show city selection with location detection
  await createRegionsUI();
});

// Handle page visibility change to refresh data
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && region) {
    // Refresh data when page becomes visible
    if (els.mainApp.classList.contains('active')) {
      loadNearestStops();
      loadCardInfo();
    }
  }
});
</script>
</body>
</html>